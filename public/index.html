<!DOCTYPE html>
<html>
<head>
    <title>Simple WebRTC DataChannel</title>
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="/adapter.js"></script>
    <script type="text/javascript" src="/simple-webrtc-datachannel.js"></script>
    <style type="text/css">

    </style>
</head>
<body>
    <script type="text/javascript">
        var MAX_PACKET_SIZE = 1200;
        var simpleDataChannel = new SimpleWebRTCDataChannel('http://'+location.host, 'test');
        simpleDataChannel.on('connect', function (ev) {
            console.log(ev.data.peerId, 'connected');
        });
        simpleDataChannel.on('disconnect', function (ev) {
            console.log(ev.data.peerId, 'disconnected');
        });

        var currentMessage = {};
        simpleDataChannel.on('message', function (event) {
            //console.log(event)
            var data = event.data,
                message;
            if (!currentMessage[data.peerId]) {
                try {
                    message = JSON.parse(data.message);
                    //console.log(message);
                    if (message.file) {
                        currentMessage[data.peerId] = {
                            info: message.file,
                            data: new ArrayBuffer(message.file.size),
                            offset: 0
                        };
                    }
                } catch (e) {
                    // not json
                    console.log(data, e)
                }
            } else {
                //console.log(data);
                message = data.message;
                if (message instanceof ArrayBuffer) {
                    writeBuffer(currentMessage[data.peerId].data, message, currentMessage[data.peerId].offset);
                    currentMessage[data.peerId].offset += message.byteLength;
                } else {
                    if (message === 'end') {
                        var finalMessage = currentMessage[data.peerId];
                        delete currentMessage[data.peerId];
                        if (finalMessage.info.type.indexOf('image') > -1) {
                            embedImg(finalMessage.info.type, finalMessage.data);
                        } else if (finalMessage.info.type.indexOf('video') > -1) {
                            embedVideo(finalMessage.info.type, finalMessage.data);
                        }
                    }
                }
            }
        });

        function embedImg(type, data) {
            var blob = new Blob([data], { type: type });
            var img = new Image();
            img.src = URL.createObjectURL(blob);
            document.body.appendChild(img);
        }

        function embedVideo(type, data) {
            var blob = new Blob([data], { type: type });
            var video = document.createElement('video');
            video.autoplay = true;
            video.loop = true;
            video.controls = true;
            video.src = URL.createObjectURL(blob);
            document.body.appendChild(video);
        }

        function writeBuffer(intoBuffer, fromBuffer, offset) {
            var fromView = new DataView(fromBuffer);
            var intoView = new DataView(intoBuffer, offset, fromBuffer.byteLength);
            for (var i = 0, l = fromBuffer.byteLength; i < l; ++i) {
                intoView.setUint8(i, fromView.getUint8(i));
            }
        }

        function sendFile(fileInfo, data) {
            var bufferView, start = 0;
            simpleDataChannel.send(JSON.stringify({
                file: fileInfo
            }));
            while (start < data.byteLength) {
                bufferView = data.slice(start, start + Math.min(MAX_PACKET_SIZE, data.byteLength - start));
                //console.dir(bufferView);
                simpleDataChannel.send(bufferView);
                start += MAX_PACKET_SIZE;
            }
            simpleDataChannel.send('end');
        }

        function cancel(event) {
            event.preventDefault();
        }

        window.addEventListener('dragover', cancel);
        window.addEventListener('dragenter', cancel);
        window.addEventListener('drop', function (event) {
            var files = event.dataTransfer.files;

            [].forEach.call(files, function (file) {
                var reader = new FileReader();
                console.log(file);
                reader.addEventListener('progress', function(event) {
                    //console.log('loaded file', this, file);
                    //simpleDataChannel.send(this);
                    console.log(this.result.byteLength);
                });
                reader.addEventListener('loadend', function(event) {
                    //console.log('loaded file', this, file);
                    //simpleDataChannel.send(this);
                    sendFile(file, this.result);
                });
                reader.readAsArrayBuffer(file);
            });

            cancel(event);
        });
    </script>
</body>
</html>
