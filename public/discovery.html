<!DOCTYPE html>
<html>
<head>
    <title>Simple WebRTC DataChannel</title>
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="/event-target.js"></script>
    <script type="text/javascript" src="/data-connection.js"></script>
    <style type="text/css">
    </style>
</head>
<body>
    <button onclick="closeAll()">die</button>
    <div class="peers"></div>
    <pre class="messages"></pre>
    <script type="text/javascript">
        var socket = io.connect('http://' + location.host);
        var myId;
        socket.on('connect', function () {
            console.log('connected');
        });
        socket.on('id', function (id) {
            myId = id;
        });
        var connections = {};
        socket.on('msg', function (id, data) {
            if (id === myId) {
                alert('got a message from myself derrrp');
                return;
            }
            console.log(data)
            if (data.offer) {
                console.log('got an offer');
                var dataConnection = new DataConnection();
                dataConnection.id = id;
                dataConnection.on('answer', function (event) {
                    socket.emit('msg', id, { answer: event.data });
                });
                dataConnection.on('candidate', function (event) {
                    socket.emit('msg', id, { candidate: event.data });
                });
                dataConnection.on('message', handleDataConnectionMessage);
                dataConnection.on('connect', function (event) {
                    console.log('connected to '+id)
                    updatePeers();
                });
                dataConnection.on('disconnect', function (event) {
                    console.log('disconnected!!!')
                    delete connections[id];
                    updatePeers();
                });
                dataConnection.on('datachannelopen', function (event) {
                    console.log('datachannelopen!!!')
                    this.send('hello');
                    sendPeers(dataConnection);
                });
                dataConnection.setDescription(data.offer);
                dataConnection.createAnswer();
                connections[id] = dataConnection;
            }
            if (data.answer) {
                console.log('got an answer');
                connections[id].setDescription(data.answer);
            }
            if (data.candidate) {
                console.log('got a candidate');
                connections[id].addCandidate(data.candidate);
            }
        });
        socket.on('peer', function (id) {
            if (id === myId) {
                alert('trying to connect to myself derrrp1');
                return;
            }
            console.log(id)
            var dataConnection = new DataConnection();
            dataConnection.id = id;
            dataConnection.on('offer', function (event) {
                socket.emit('msg', id, { offer: event.data });
            });
            dataConnection.on('candidate', function (event) {
                socket.emit('msg', id, { candidate: event.data });
            });
            dataConnection.on('message', handleDataConnectionMessage);
            dataConnection.on('connect', function (event) {
                console.log('connected to '+id)
                updatePeers();
            });
            dataConnection.on('disconnect', function (event) {
                console.log('disconnected!!!')
                delete connections[id];
                updatePeers();
            });
            dataConnection.on('datachannelopen', function (event) {
                console.log('datachannelopen!!!')
                sendPeers(dataConnection);
            });
            dataConnection.createOffer();
            connections[id] = dataConnection;
        });

        function closeAll() {
            socket.disconnect();
            for (var id in connections) {
                connections[id] && connections[id].close();
            }
        }

        function sendPeers(dataConnection) {
            var peers = [];
            for (var c in connections) {
                peers.push(c);
            }
            dataConnection.send(JSON.stringify({ peers: peers }));
        }

        function handleDataConnectionMessage(event) {
            var data,
                dataConnection = this;
            try {
                data = JSON.parse(event.data);
            } catch (e) {
                data = event.data;
            }
            if (data.peers) {
                data.peers.forEach(function (id) {
                    if (id !== myId && !connections[id]) {
                        addPeer(id, dataConnection);
                    }
                });
            }
            if (data.to) {
                if (connections[data.to]) {
                    //console.log('forwarding message to '+ data.to, data.message);
                    connections[data.to].send(JSON.stringify(data.message));
                } else {
                    console.error('no connection exists with id (to): ' + data.to);
                }
            }
            if (data.from) {

                if (data.offer) {
                    console.log('got an offer from ' + data.from + ' through ' + this.id);
                    addPeer(data.from, dataConnection, data.offer);
                }

                if (connections[data.from]) {
                    if (data.answer) {
                        console.log('got an answer from' + data.from + ' through ' + this.id);
                        connections[data.from].setDescription(data.answer);
                    }
                    if (data.candidate) {
                        console.log('got a candidate from ' + data.from + ' through ' + this.id);
                        connections[data.from].addCandidate(data.candidate);
                    }
                } else {
                    console.error('got message from ' + data.from + ', but it does not exist!');
                }
            }
            addMessage(this.id, event.data);
            //console.log(data);
        }

        function addPeer(id, bridgeConnection, offer) {
            console.log('trying to make a connection to ' + id + ' through ' + bridgeConnection.id +' createOffer:'+ !offer);
            var dataConnection = new DataConnection();
            dataConnection.id = id;
            dataConnection.on('offer', function (event) {
                console.log('sending offer to ' + id + ' through ' + bridgeConnection.id);
                bridgeConnection.send(JSON.stringify({ to: id, message: { from: myId, offer: event.data } }));
            });
            dataConnection.on('answer', function (event) {
                console.log('sending answer to ' + id + ' through ' + bridgeConnection.id);
                bridgeConnection.send(JSON.stringify({ to: id, message: { from: myId, answer: event.data } }));
            });
            dataConnection.on('candidate', function (event) {
                console.log('sending candidate to ' + id + ' through ' + bridgeConnection.id);
                bridgeConnection.send(JSON.stringify({ to: id, message: { from: myId, candidate: event.data } }));
            });
            dataConnection.on('message', handleDataConnectionMessage);
            dataConnection.on('connect', function (event) {
                console.log('connected to ' + id + ' through ' + bridgeConnection.id);
                updatePeers();
            });
            dataConnection.on('datachannelopen', function (event) {
                console.log('datachannelopen!!!');
                this.send('BAM connected!!!');
                sendPeers(dataConnection);
            });
            dataConnection.on('disconnect', function (event) {
                console.log('disconnected!!!');
                delete connections[id];
                updatePeers();
            });
            if (offer) {
                dataConnection.setDescription(offer);
                dataConnection.createAnswer();
            } else {
                dataConnection.createOffer();
            }
            connections[id] = dataConnection;
        }

        function makeEl(name) {
            return document.createElement(name);
        }

        function updatePeers() {
            var peers = document.querySelector('.peers');
            peers.innerHTML = '';
            var div = makeEl('div');
            div.innerText = 'I am ' + myId + ', and I am connected to:';
            peers.appendChild(div);
            for (var id in connections) {
                div = makeEl('div');
                var input = makeInput(id);
                div.innerText = id;
                div.appendChild(input);
                peers.appendChild(div);
            }
        }

        function makeInput(id) {
            var input = makeEl('input');
            input.addEventListener('keydown', function (event) {
                if (event.keyCode === 13) {
                    connections[id].send(this.value);
                    this.value = '';
                    event.preventDefault();
                }
            });
            return input;
        }

        function addMessage(id, msg) {
            var messages = document.querySelector('.messages');
            messages.innerText += id + ': ' + msg + '\n';
        }

        function createConnectionTo(id) {

        }
    </script>
</body>
</html>
